<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bioritmo – Calcolatore Responsive</title>
<style>
  :root{
    --bg:#0f1115; --panel:#171a21; --ink:#e7eaf0; --muted:#9aa3b2; --grid:#2a2f3a;
    --p:#4da3ff; --e:#ff6b88; --i:#55d69e; --zero:#c7cbd4;
    --accent:#ffd166; --focus:#7ab8ff33;
    --radius:14px; --gap:12px; --shadow:0 6px 20px rgba(0,0,0,.35);
    font-synthesis-weight:none; /* testo più nitido */
  }
  html,body{height:100%}
  body{
    margin:0; background:linear-gradient(180deg,#0e1014, #0b0d11 120%);
    color:var(--ink); font:500 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
    display:grid; place-items:stretch;
  }
  .wrap{
    max-width:1100px; margin:auto; padding:20px; width:100%; box-sizing:border-box;
    display:grid; gap:var(--gap);
  }
  header{
    display:flex; flex-wrap:wrap; gap:10px 14px; align-items:center; justify-content:space-between;
  }
  header h1{font-size:clamp(18px,2.5vw,22px); margin:0; letter-spacing:.2px}
  .panel{
    background:var(--panel); border-radius:var(--radius); box-shadow:var(--shadow); border:1px solid #222838;
  }
  .controls{
    display:grid; grid-template-columns:1fr; gap:var(--gap); padding:14px; }
  .row{ display:grid; gap:10px; grid-template-columns: 1fr 1fr; }
  .row > * { min-width:0; }
  .row-3{ grid-template-columns: 1fr 1fr 1fr; }
  label{ font-size:13px; color:var(--muted); display:block; margin-bottom:6px; }
  input, select, button{
    width:100%; box-sizing:border-box; background:#0f131b; color:var(--ink);
    border:1px solid #2a3040; border-radius:10px; padding:10px 12px; outline:none;
  }
  input:focus, select:focus, button:focus { box-shadow:0 0 0 4px var(--focus); border-color:#3b82f6; }
  button{ cursor:pointer; background:#1a2130; transition:.2s background, .2s transform; }
  button:hover{ background:#20293b; }
  button:active{ transform:translateY(1px); }

  .chart-card{ padding:10px; display:grid; gap:8px; }
  .legend{
    display:flex; flex-wrap:wrap; gap:10px; padding:0 6px 6px; align-items:center; justify-content:flex-start;
  }
  .chip{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid #2a3040; border-radius:999px; font-size:13px; color:#cfd6e4; }
  .dot{ width:14px; height:6px; border-radius:3px; display:inline-block; }
  .p{ background:var(--p); } .e{ background:var(--e);} .i{ background:var(--i);}
  .canvas{
    position:relative; width:100%; aspect-ratio: 16/10;
    background:linear-gradient(180deg,#101520,#0f141f);
    border:1px solid #1e2431; border-radius:12px; overflow:hidden;
  }
  svg{ width:100%; height:100%; display:block; }

  /* Tooltip */
  .tip{
    position:absolute; pointer-events:none; background:#0b0f17; color:#e8ecf6; border:1px solid #263049;
    padding:8px 10px; font-size:13px; border-radius:10px; box-shadow:var(--shadow); max-width:min(280px,88vw);
    transform:translate(-50%,-110%); white-space:nowrap;
  }
  .tip ul{ list-style:none; margin:6px 0 0; padding:0; display:grid; gap:2px;}
  .tip .t-date{ font-size:12px; color:var(--muted); }
  .tip .rowv{ display:flex; align-items:center; gap:8px; }
  .tip .val{ font-variant-numeric:tabular-nums; }

  /* Cursor line */
  .cursor{ stroke:var(--accent); stroke-width:1.2; stroke-dasharray:5 4; opacity:.8; }

  /* Footer/help */
  .help { color:var(--muted); font-size:13px; padding:10px 14px 14px; }
  .grid-note{ color:#a7b0c0; }

  /* Mobile optimizations */
  @media (max-width: 720px){
    .row{ grid-template-columns:1fr; }
    .legend{ gap:6px; }
    .chip{ font-size:12px; padding:6px 8px; }
    .canvas{ aspect-ratio: 4/3; }
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Calcolatore di Bioritmo</h1>
    </header>

    <section class="panel controls" aria-label="Impostazioni bioritmo">
      <div class="row">
        <div>
          <label for="birth">Data di nascita</label>
          <input id="birth" type="date" aria-describedby="birthHelp" />
        </div>
        <div>
          <label for="center">Data di riferimento</label>
          <input id="center" type="date" />
        </div>
      </div>
      <div class="row-3">
        <div>
          <label for="range">Intervallo (giorni totali)</label>
          <select id="range">
            <option value="15">15</option>
            <option value="30" selected>30</option>
            <option value="60">60</option>
            <option value="90">90</option>
          </select>
        </div>
        <div>
          <label for="gran">Granularità</label>
          <select id="gran">
            <option value="1" selected>Giorni</option>
            <option value="0.5">½ giorno</option>
          </select>
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="today">Vai a oggi</button>
        </div>
      </div>
    </section>

    <section class="panel chart-card" aria-label="Grafico bioritmo">
      <div class="legend" role="list" aria-label="Legenda">
        <span class="chip" role="listitem"><span class="dot p" aria-hidden="true"></span> Fisico (23g)</span>
        <span class="chip" role="listitem"><span class="dot e" aria-hidden="true"></span> Emotivo (28g)</span>
        <span class="chip" role="listitem"><span class="dot i" aria-hidden="true"></span> Intellettuale (33g)</span>
        <span class="chip grid-note" role="listitem">Linea 0% = equilibrio</span>
      </div>

      <div class="canvas" id="canvas" aria-label="Area grafico">
        <svg id="svg" viewBox="0 0 1000 650" role="img" aria-labelledby="title desc">
          <title id="title">Grafico dei bioritmi</title>
          <desc id="desc">Curve dei cicli Fisico, Emotivo e Intellettuale su intervallo selezionato. Scala da -100% a +100% con linea dello zero.</desc>
          <!-- Griglia e assi verranno inseriti via JS -->
        </svg>
        <div class="tip" id="tip" hidden></div>
      </div>

      <div class="help">
        Suggerimento: tocca o muovi il mouse sul grafico per leggere i valori esatti nel giorno selezionato. I tooltip vengono unificati
        per evitare sovrapposizioni e migliorare la leggibilità.
      </div>
    </section>
  </div>

<script>
(function(){
  // ---------- Utilità date/numero ----------
  const MS_DAY = 86400000;
  const clamp = (v,min,max)=>Math.min(max,Math.max(min,v));
  const fmtPct = v => (v*100).toFixed(0) + '%';
  const toISODate = d => new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,10);
  const parseDate = s => { const d = new Date(s); if(Number.isNaN(d)) return null; return new Date(d.getFullYear(), d.getMonth(), d.getDate()); };
  const daysBetween = (d1,d2)=> Math.floor((d2 - d1)/MS_DAY);

  // ---------- Stato ----------
  const state = {
    birth: null,
    center: null,
    totalDays: 30,
    step: 1, // giorni
    width: 1000, height: 650,
    padding: {l:60, r:20, t:20, b:50},
    cycles: [
      { key:'p', name:'Fisico', period:23, color:'var(--p)' },
      { key:'e', name:'Emotivo', period:28, color:'var(--e)' },
      { key:'i', name:'Intellettuale', period:33, color:'var(--i)' },
    ]
  };

  // ---------- DOM ----------
  const birthEl = document.getElementById('birth');
  const centerEl = document.getElementById('center');
  const rangeEl = document.getElementById('range');
  const granEl = document.getElementById('gran');
  const todayBtn = document.getElementById('today');
  const svg = document.getElementById('svg');
  const tip = document.getElementById('tip');
  const canvas = document.getElementById('canvas');

  // Default valori
  const today = new Date();
  centerEl.value = toISODate(today);
  state.center = parseDate(centerEl.value);

  // Prova a impostare una data di nascita plausibile (30 anni fa)
  const dfltBirth = new Date(today.getFullYear()-30, today.getMonth(), today.getDate());
  birthEl.value = toISODate(dfltBirth);
  state.birth = parseDate(birthEl.value);

  // ---------- Eventi ----------
  birthEl.addEventListener('change', ()=>{ state.birth = parseDate(birthEl.value); draw(); });
  centerEl.addEventListener('change', ()=>{ state.center = parseDate(centerEl.value); draw(); });
  rangeEl.addEventListener('change', ()=>{ state.totalDays = +rangeEl.value; draw(); });
  granEl.addEventListener('change', ()=>{ state.step = +granEl.value; draw(); });
  todayBtn.addEventListener('click', ()=>{ centerEl.value = toISODate(new Date()); state.center = parseDate(centerEl.value); draw(); });

  // Ridisegna al resize mantenendo rapporto
  new ResizeObserver(()=> draw()).observe(canvas);

  // ---------- Calcolo bioritmi ----------
  function bioValue(daysSinceBirth, period){
    return Math.sin(2*Math.PI * (daysSinceBirth/period)); // -1..+1
  }
  function genData(){
    const {birth, center, totalDays, step} = state;
    if(!birth || !center) return [];

    const half = Math.floor(totalDays/2);
    const start = new Date(center.getTime() - half*MS_DAY);
    const points = [];
    for(let i=0; i<=totalDays/step; i++){
      const t = new Date(start.getTime() + i*step*MS_DAY);
      const days = daysBetween(birth, t);
      const entry = { t, x:i*step };
      state.cycles.forEach(cy => entry[cy.key] = bioValue(days, cy.period));
      points.push(entry);
    }
    return points;
  }

  // ---------- Rendering ----------
  function clearSVG(){
    while(svg.firstChild) svg.removeChild(svg.firstChild);
  }
  function drawGrid(xScale, yScale, data){
    const g = el('g', { 'aria-hidden':'true' });
    // area disegno
    const {l,r,t,b} = state.padding;
    const W = state.width, H = state.height;
    const plotW = W - l - r, plotH = H - t - b;

    // sfondo
    g.appendChild(rect(l,t,plotW,plotH,{ fill:'url(#bgGrad)' }));

    // linee orizzontali (-100, -50, 0, +50, +100)
    [-1,-0.5,0,0.5,1].forEach(v=>{
      const y = yScale(v);
      const isZero = Math.abs(v) < 1e-9;
      g.appendChild(line(l,y,W-r,y,{ stroke: isZero? 'var(--zero)':'var(--grid)', 'stroke-width': isZero? 1.4:1, 'stroke-dasharray': isZero? '': '4 6', opacity: isZero? .9:.8 }));
      const label = (v*100).toFixed(0)+'%';
      g.appendChild(text(l-10, y+4, label, { 'text-anchor':'end', fill:isZero? 'var(--zero)':'#9aa3b2', 'font-size':12 }));
    });

    // linee verticali (una ogni 5 giorni circa)
    const approx = Math.max(5, Math.round(data.length/6));
    for(let i=0;i<data.length;i+=approx){
      const x = xScale(i*state.step);
      g.appendChild(line(x,t,x,H-b,{ stroke:'var(--grid)', 'stroke-width':1, 'stroke-dasharray':'4 6', opacity:.7 }));
      const d = data[i]?.t;
      if(d){
        g.appendChild(text(x, H-b+18, fmtDate(d), { 'text-anchor':'middle', fill:'#9aa3b2', 'font-size':12 }));
      }
    }

    // assi
    g.appendChild(line(l,t,l,H-b,{ stroke:'#2a3040', 'stroke-width':1.3 }));
    g.appendChild(line(l,H-b,W-r,H-b,{ stroke:'#2a3040', 'stroke-width':1.3 }));

    svg.appendChild(g);
  }

  function drawCurves(xScale, yScale, data){
    const g = el('g', { fill:'none' });
    state.cycles.forEach(cy=>{
      const d = pathD(data.map((p,idx)=>[ xScale(p.x), yScale(p[cy.key]) ]));
      g.appendChild(el('path', { d, stroke: `var(--${cy.key})`, 'stroke-width':2.2, 'vector-effect':'non-scaling-stroke' }));
    });
    svg.appendChild(g);
  }

  function drawCursor(xScale, yScale, data){
    const g = el('g', { id:'cursorLayer' });
    const {l,r,t,b} = state.padding;
    const H = state.height, W = state.width;
    const plotW = W - l - r;

    // linea cursore
    const cursorLine = line(l, t, l, H-b, { class:'cursor' });
    g.appendChild(cursorLine);
    svg.appendChild(g);

    // Interazione
    function updateFromClientX(clientX){
      const rect = svg.getBoundingClientRect();
      const px = clamp(clientX - rect.left, l, W - r);
      const proportion = (px - l)/plotW;
      const idx = clamp(Math.round(proportion*(data.length-1)), 0, data.length-1);
      const p = data[idx];
      cursorLine.setAttribute('x1', xScale(p.x));
      cursorLine.setAttribute('x2', xScale(p.x));
      showTip(p, xScale, yScale);
    }
    function leave(){
      tip.hidden = true;
    }
    // eventi mouse/touch
    svg.onpointermove = (ev)=>{ updateFromClientX(ev.clientX); };
    svg.onpointerleave = leave;
    svg.ontouchstart = (ev)=>{ if(ev.touches?.[0]) updateFromClientX(ev.touches[0].clientX); };
    svg.ontouchmove = (ev)=>{ if(ev.touches?.[0]) updateFromClientX(ev.touches[0].clientX); };
  }

  function showTip(p, xScale, yScale){
    const items = state.cycles
      .map(cy => ({ key:cy.key, name:cy.name, color:`var(--${cy.key})`, val:p[cy.key] }))
      .sort((a,b)=> Math.abs(b.val) - Math.abs(a.val)); // ordina per importanza

    // HTML del tooltip unificato (niente sovrapposizioni)
    tip.innerHTML = `
      <div class="t-date">${fmtDate(p.t)} — giorno ${daysBetween(state.birth,p.t)} dalla nascita</div>
      <ul>
        ${items.map(it=>`
          <li class="rowv">
            <span class="dot ${it.key}" style="width:10px;height:10px;border-radius:50%"></span>
            <span>${it.name}</span>
            <span class="val" style="margin-left:auto">${fmtPct(it.val)}</span>
          </li>`).join('')}
      </ul>
    `;
    tip.hidden = false;

    // posizionamento vicino alla linea, evitando bordi
    const rect = svg.getBoundingClientRect();
    const x = xScale(p.x) - rect.left;
    const y = yScale(0) - rect.top - 10; // sopra la linea zero per stabilità
    tip.style.left = x + 'px';
    tip.style.top = y + 'px';

    // flip se esce a destra/sinistra
    const tw = tip.offsetWidth, th = tip.offsetHeight;
    const pad = 8;
    const left = clamp(x - tw/2, pad, rect.width - tw - pad);
    const top = clamp(y - th - 8, pad, rect.height - th - pad);
    tip.style.left = left + 'px';
    tip.style.top = top + 'px';
  }

  function draw(){
    if(!state.birth || !state.center) return;

    // dimensioni correnti (responsive)
    const rect = canvas.getBoundingClientRect();
    state.width = 1000; state.height = 650; // viewBox fissa, scala via SVG
    clearSVG();

    // Definizioni (gradient)
    const defs = el('defs', {});
    const grad = el('linearGradient',{id:'bgGrad', x1:'0',y1:'0',x2:'0',y2:'1'});
    grad.appendChild(el('stop',{offset:'0%', stop-color:'#101623'}));
    grad.appendChild(el('stop',{offset:'100%', stop-color:'#0c111b'}));
    defs.appendChild(grad);
    svg.appendChild(defs);

    const data = genData();
    const {l,r,t,b} = state.padding;
    const W = state.width, H = state.height;

    const xMin = 0, xMax = state.totalDays; // giorni
    const yMin = -1, yMax = 1;

    const xScale = x => l + ( (x - xMin) / (xMax - xMin) ) * (W - l - r);
    const yScale = y => H - b - ( (y - yMin) / (yMax - yMin) ) * (H - t - b);

    // griglia e curve
    drawGrid(xScale,yScale,data);
    drawCurves(xScale,yScale,data);
    drawXAxisTicks(xScale);
    drawCursor(xScale,yScale,data);
  }

  function drawXAxisTicks(xScale){
    // Etichette compatte ai bordi: inizio/fine
    const {l,r,t,b} = state.padding;
    const H = state.height, W = state.width;
    const start = new Date(state.center.getTime() - Math.floor(state.totalDays/2)*MS_DAY);
    const end = new Date(state.center.getTime() + Math.floor(state.totalDays/2)*MS_DAY);
    svg.appendChild(text(l, H-b+32, fmtDate(start), { 'text-anchor':'start', fill:'#9aa3b2', 'font-size':12 }));
    svg.appendChild(text(W-r, H-b+32, fmtDate(end), { 'text-anchor':'end', fill:'#9aa3b2', 'font-size':12 }));
  }

  // ---------- SVG helpers ----------
  function el(n, attrs){ const e = document.createElementNS('http://www.w3.org/2000/svg', n); for(const k in attrs){ e.setAttribute(k, attrs[k]); } return e; }
  const line = (x1,y1,x2,y2,attrs={})=>{ const e=el('line',{x1,y1,x2,y2,...attrs}); return e; };
  const rect = (x,y,w,h,attrs={})=>{ const e=el('rect',{x,y,width:w,height:h,...attrs}); return e; };
  const text = (x,y,txt,attrs={})=>{ const e=el('text',{x,y,...attrs}); e.textContent = txt; return e; };

  function pathD(points){
    // Catmull-Rom to cubic Bezier per curve lisce e precise
    if(points.length<2) return '';
    const d=[];
    for(let i=0;i<points.length;i++){
      const p0 = points[i-1] || points[i];
      const p1 = points[i];
      const p2 = points[i+1] || points[i];
      const p3 = points[i+2] || p2;
      if(i===0) d.push(`M ${p1[0]} ${p1[1]}`);
      const c1x = p1[0] + (p2[0]-p0[0])/6;
      const c1y = p1[1] + (p2[1]-p0[1])/6;
      const c2x = p2[0] - (p3[0]-p1[0])/6;
      const c2y = p2[1] - (p3[1]-p1[1])/6;
      d.push(`C ${c1x} ${c1y}, ${c2x} ${c2y}, ${p2[0]} ${p2[1]}`);
    }
    return d.join(' ');
  }

  function fmtDate(d){
    // dd MMM yyyy in italiano
    const months = ['gen','feb','mar','apr','mag','giu','lug','ago','set','ott','nov','dic'];
    return `${String(d.getDate()).padStart(2,'0')} ${months[d.getMonth()]} ${d.getFullYear()}`;
  }

  // Primo disegno
  draw();
})();
</script>
</body>
</html>