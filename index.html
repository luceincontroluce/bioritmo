<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Bioritmo – Calcolatore Responsive</title>
<style>
  :root{
    --bg:#0f1115; --panel:#171a21; --ink:#e7eaf0; --muted:#9aa3b2; --grid:#2a2f3a;
    --p:#4da3ff; --e:#ff6b88; --i:#55d69e; --zero:#c7cbd4;
    --accent:#ffd166; --focus:#7ab8ff33;
    --radius:14px; --gap:12px; --shadow:0 6px 20px rgba(0,0,0,.35);
    font-synthesis-weight:none;
  }
  html,body{height:100%}
  body{
    margin:0; background:linear-gradient(180deg,#0e1014, #0b0d11 120%);
    color:var(--ink); font:500 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
    display:grid; place-items:stretch;
  }
  .wrap{
    max-width:1100px; margin:auto; padding:20px; width:100%; box-sizing:border-box;
    display:grid; gap:var(--gap);
  }
  header{
    display:flex; flex-wrap:wrap; gap:10px 14px; align-items:center; justify-content:space-between;
  }
  header h1{font-size:clamp(18px,2.5vw,22px); margin:0; letter-spacing:.2px}
  .panel{
    background:var(--panel); border-radius:var(--radius); box-shadow:var(--shadow); border:1px solid #222838;
  }
  .controls{
    display:grid; grid-template-columns:1fr; gap:var(--gap); padding:14px;
  }
  .row{ display:grid; gap:10px; grid-template-columns: 1fr 1fr; }
  .row > * { min-width:0; }
  .row-3{ grid-template-columns: 1fr 1fr 1fr; }
  .row-btns{ display:flex; flex-wrap:wrap; gap:8px; }
  label{ font-size:13px; color:var(--muted); display:block; margin-bottom:6px; }
  input, select, button{
    width:100%; box-sizing:border-box; background:#0f131b; color:var(--ink);
    border:1px solid #2a3040; border-radius:10px; padding:10px 12px; outline:none;
  }
  input:focus, select:focus, button:focus { box-shadow:0 0 0 4px var(--focus); border-color:#3b82f6; }
  button{ cursor:pointer; background:#1a2130; transition:.2s background, .2s transform; }
  button:hover{ background:#20293b; }
  button:active{ transform:translateY(1px); }

  .chart-card{ padding:10px; display:grid; gap:8px; }
  .legend{
    display:flex; flex-wrap:wrap; gap:10px; padding:0 6px 6px; align-items:center; justify-content:flex-start;
  }
  .chip{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid #2a3040; border-radius:999px; font-size:13px; color:#cfd6e4; }
  .dot{ width:14px; height:6px; border-radius:3px; display:inline-block; }
  .p{ background:var(--p); } .e{ background:var(--e);} .i{ background:var(--i);}
  .canvas{
    position:relative; width:100%; aspect-ratio: 16/10;
    background:linear-gradient(180deg,#101520,#0f141f);
    border:1px solid #1e2431; border-radius:12px; overflow:hidden;
  }
  /* Blocca scroll durante drag sul grafico */
  .canvas svg { touch-action: none; }

  svg{ width:100%; height:100%; display:block; }

  /* Tooltip */
  .tip{
    position:absolute; pointer-events:none; background:#0b0f17; color:#e8ecf6; border:1px solid #263049;
    padding:8px 10px; font-size:13px; border-radius:10px; box-shadow:var(--shadow); max-width:min(280px,88vw);
    transform:translate(-50%,-110%); white-space:nowrap;
  }
  .tip ul{ list-style:none; margin:6px 0 0; padding:0; display:grid; gap:2px;}
  .tip .t-date{ font-size:12px; color:var(--muted); }
  .tip .rowv{ display:flex; align-items:center; gap:8px; }
  .tip .val{ font-variant-numeric:tabular-nums; }

  /* Cursor line */
  .cursor{ stroke:var(--accent); stroke-width:1.2; stroke-dasharray:5 4; opacity:.8; }

  /* Footer/help */
  .help { color:var(--muted); font-size:13px; padding:10px 14px 14px; }
  .grid-note{ color:#a7b0c0; }

  /* Mobile optimizations */
  @media (max-width: 720px){
    .row{ grid-template-columns:1fr; }
    .legend{ gap:6px; }
    .chip{ font-size:12px; padding:6px 8px; }
    .canvas{ aspect-ratio: 4/3; }
  }
  /* Legenda ancora più compatta sotto 420px */
  @media (max-width:420px){
    .legend{ gap:4px }
    .chip{ padding:4px 8px; font-size:11.5px }
  }

  /* Stampa/PDF: margini puliti e sfondo chiaro */
  @media print{
    body{ background:#fff }
    .panel{ box-shadow:none; border:0 }
    .help,.controls,header{ display:none }
    .canvas{ border:0; }
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Calcolatore di Bioritmo</h1>
    </header>

    <section class="panel controls" aria-label="Impostazioni bioritmo">
      <div class="row">
        <div>
          <label for="birth">Data di nascita</label>
          <input id="birth" type="date" aria-describedby="birthHelp" />
        </div>
        <div>
          <label for="center">Data di riferimento</label>
          <input id="center" type="date" />
        </div>
      </div>
      <div class="row-3">
        <div>
          <label for="range">Intervallo (giorni totali)</label>
          <select id="range">
            <option value="15">15</option>
            <option value="30" selected>30</option>
            <option value="60">60</option>
            <option value="90">90</option>
          </select>
        </div>
        <div>
          <label for="gran">Granularità</label>
          <select id="gran">
            <option value="1" selected>Giorni</option>
            <option value="0.5">½ giorno</option>
          </select>
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="today">Vai a oggi</button>
        </div>
      </div>

      <div class="row-btns" aria-label="Azioni">
        <button id="exportPng">Esporta PNG</button>
        <button id="exportPdf">Esporta PDF</button>
        <button id="copyLink">Copia link con parametri</button>
      </div>
    </section>

    <section class="panel chart-card" aria-label="Grafico bioritmo">
      <div class="legend" role="list" aria-label="Legenda">
        <span class="chip" role="listitem"><span class="dot p" aria-hidden="true"></span> Fisico (23g)</span>
        <span class="chip" role="listitem"><span class="dot e" aria-hidden="true"></span> Emotivo (28g)</span>
        <span class="chip" role="listitem"><span class="dot i" aria-hidden="true"></span> Intellettuale (33g)</span>
        <span class="chip grid-note" role="listitem">Linea 0% = equilibrio</span>
      </div>

      <div class="canvas" id="canvas" aria-label="Area grafico">
        <svg id="svg" viewBox="0 0 1000 650" role="img" aria-labelledby="title desc">
          <title id="title">Grafico dei bioritmi</title>
          <desc id="desc">Curve dei cicli Fisico, Emotivo e Intellettuale su intervallo selezionato. Scala da -100% a +100% con linea dello zero.</desc>
          <!-- Griglia e assi via JS -->
        </svg>
        <div class="tip" id="tip" hidden></div>
      </div>

      <div class="help">
        Suggerimento: tocca o muovi il mouse sul grafico per leggere i valori esatti nel giorno selezionato. I tooltip vengono unificati
        per evitare sovrapposizioni e migliorare la leggibilità.
      </div>
    </section>
  </div>

<script>
(function(){
  // ---------- Utilità date/numero ----------
  const MS_DAY = 86400000;
  const clamp = (v,min,max)=>Math.min(max,Math.max(min,v));
  const fmtPct = v => (v*100).toFixed(0) + '%';
  const toISODate = d => new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,10);
  const parseDate = s => { const d = new Date(s); if(Number.isNaN(d)) return null; return new Date(d.getFullYear(), d.getMonth(), d.getDate()); };
  const daysBetween = (d1,d2)=> Math.floor((d2 - d1)/MS_DAY);

  // ---------- Stato ----------
  const state = {
    birth: null,
    center: null,
    totalDays: 30,
    step: 1, // giorni
    width: 1000, height: 650,
    padding: {l:60, r:20, t:20, b:50},
    cycles: [
      { key:'p', name:'Fisico', period:23, color:'var(--p)' },
      { key:'e', name:'Emotivo', period:28, color:'var(--e)' },
      { key:'i', name:'Intellettuale', period:33, color:'var(--i)' },
    ]
  };

  // ---------- DOM ----------
  const birthEl = document.getElementById('birth');
  const centerEl = document.getElementById('center');
  const rangeEl = document.getElementById('range');
  const granEl = document.getElementById('gran');
  const todayBtn = document.getElementById('today');
  const exportPngBtn = document.getElementById('exportPng');
  const exportPdfBtn = document.getElementById('exportPdf');
  const copyLinkBtn  = document.getElementById('copyLink');

  const svg = document.getElementById('svg');
  const tip = document.getElementById('tip');
  const canvas = document.getElementById('canvas');

  // ---------- URL <-> Stato ----------
  function paramsFromURL(){
    const u = new URL(location.href);
    const b = u.searchParams.get('b'); // birth yyyy-mm-dd
    const c = u.searchParams.get('c'); // center yyyy-mm-dd
    const r = u.searchParams.get('r'); // range
    const g = u.searchParams.get('g'); // gran
    if(b) { birthEl.value = b; state.birth = parseDate(b); }
    if(c) { centerEl.value = c; state.center = parseDate(c); }
    if(r) { rangeEl.value = r; state.totalDays = +r; }
    if(g) { granEl.value = g; state.step = +g; }
  }
  function pushURL(){
    const u = new URL(location.href);
    u.searchParams.set('b', birthEl.value);
    u.searchParams.set('c', centerEl.value);
    u.searchParams.set('r', rangeEl.value);
    u.searchParams.set('g', granEl.value);
    history.replaceState(null, '', u);
  }

  // Default valori (solo se non presenti in URL)
  (function initDefaults(){
    const u = new URL(location.href);
    if(!u.searchParams.get('c')){
      const today = new Date();
      centerEl.value = toISODate(today);
      state.center = parseDate(centerEl.value);
    } else {
      state.center = parseDate(centerEl.value);
    }
    if(!u.searchParams.get('b')){
      const today = new Date();
      const dfltBirth = new Date(today.getFullYear()-30, today.getMonth(), today.getDate());
      birthEl.value = toISODate(dfltBirth);
      state.birth = parseDate(birthEl.value);
    } else {
      state.birth = parseDate(birthEl.value);
    }
  })();

  // Carica eventuali parametri dall’URL e disegna
  paramsFromURL();

  // ---------- Eventi ----------
  function onChange(){ pushURL(); draw(); }
  birthEl.addEventListener('change', ()=>{ state.birth = parseDate(birthEl.value); onChange(); });
  centerEl.addEventListener('change', ()=>{ state.center = parseDate(centerEl.value); onChange(); });
  rangeEl.addEventListener('change', ()=>{ state.totalDays = +rangeEl.value; onChange(); });
  granEl.addEventListener('change', ()=>{ state.step = +granEl.value; onChange(); });
  todayBtn.addEventListener('click', ()=>{ centerEl.value = toISODate(new Date()); state.center = parseDate(centerEl.value); onChange(); });

  copyLinkBtn.addEventListener('click', async ()=>{
    pushURL();
    try{
      await navigator.clipboard.writeText(location.href);
      toast('Link copiato ✅');
    }catch(e){
      prompt('Copia il link:', location.href);
    }
  });

  exportPngBtn.addEventListener('click', async ()=>{
    const dataUrl = await exportCurrentChartPNG(2); // 2x
    downloadDataURL(dataUrl, fileBaseName() + '.png');
  });

  exportPdfBtn.addEventListener('click', async ()=>{
    const dataUrl = await exportCurrentChartPNG(2);
    openPrintWindow(dataUrl);
  });

  // Ridisegna al resize
  new ResizeObserver(()=> draw()).observe(canvas);

  // ---------- Calcolo bioritmi ----------
  function bioValue(daysSinceBirth, period){
    return Math.sin(2*Math.PI * (daysSinceBirth/period)); // -1..+1
  }
  function genData(){
    const {birth, center, totalDays, step} = state;
    if(!birth || !center) return [];

    const half = Math.floor(totalDays/2);
    const start = new Date(center.getTime() - half*MS_DAY);
    const points = [];
    for(let i=0; i<=totalDays/step; i++){
      const t = new Date(start.getTime() + i*step*MS_DAY);
      const days = daysBetween(birth, t);
      const entry = { t, x:i*step };
      state.cycles.forEach(cy => entry[cy.key] = bioValue(days, cy.period));
      points.push(entry);
    }
    return points;
  }

  // ---------- Rendering ----------
  function clearSVG(){
    while(svg.firstChild) svg.removeChild(svg.firstChild);
  }
  function drawGrid(xScale, yScale, data){
    const g = el('g', { 'aria-hidden':'true' });
    const {l,r,t,b} = state.padding;
    const W = state.width, H = state.height;
    const plotW = W - l - r, plotH = H - t - b;

    // sfondo
    g.appendChild(rect(l,t,plotW,plotH,{ fill:'url(#bgGrad)' }));

    // linee orizzontali (-100, -50, 0, +50, +100)
    [-1,-0.5,0,0.5,1].forEach(v=>{
      const y = yScale(v);
      const isZero = Math.abs(v) < 1e-9;
      g.appendChild(line(l,y,W-r,y,{ stroke: isZero? 'var(--zero)':'var(--grid)', 'stroke-width': isZero? 1.4:1, 'stroke-dasharray': isZero? '': '4 6', opacity: isZero? .9:.8 }));
      const label = (v*100).toFixed(0)+'%';
      g.appendChild(text(l-10, y+4, label, { 'text-anchor':'end', fill:isZero? 'var(--zero)':'#9aa3b2', 'font-size':12 }));
    });

    // linee verticali (una ogni ~6 tacche)
    const approx = Math.max(5, Math.round(data.length/6));
    for(let i=0;i<data.length;i+=approx){
      const x = xScale(i*state.step);
      g.appendChild(line(x,t,x,H-b,{ stroke:'var(--grid)', 'stroke-width':1, 'stroke-dasharray':'4 6', opacity:.7 }));
      const d = data[i]?.t;
      if(d){
        g.appendChild(text(x, H-b+18, fmtDate(d), { 'text-anchor':'middle', fill:'#9aa3b2', 'font-size':12 }));
      }
    }

    // assi
    g.appendChild(line(l,t,l,H-b,{ stroke:'#2a3040', 'stroke-width':1.3 }));
    g.appendChild(line(l,H-b,W-r,H-b,{ stroke:'#2a3040', 'stroke-width':1.3 }));

    svg.appendChild(g);
  }

  // Curve lineari (no overshoot)
  function drawCurves(xScale, yScale, data){
    const g = el('g', { fill:'none' });
    state.cycles.forEach(cy=>{
      const pts = data.map(p=>[ xScale(p.x), yScale(p[cy.key]) ]);
      const d = pathLinear(pts);
      g.appendChild(el('path', { d, stroke: `var(--${cy.key})`, 'stroke-width':2.2, 'vector-effect':'non-scaling-stroke' }));
    });
    svg.appendChild(g);
  }

  function drawCursor(xScale, yScale, data){
    const g = el('g', { id:'cursorLayer' });
    const {l,r,t,b} = state.padding;
    const H = state.height, W = state.width;
    const plotW = W - l - r;

    // linea cursore
    const cursorLine = line(l, t, l, H-b, { class:'cursor' });
    g.appendChild(cursorLine);
    svg.appendChild(g);

    // Interazione
    function updateFromClientX(clientX){
      const rect = svg.getBoundingClientRect();
      const px = clamp(clientX - rect.left, l, W - r);
      const proportion = (px - l)/plotW;
      const idx = clamp(Math.round(proportion*(data.length-1)), 0, data.length-1);
      const p = data[idx];
      cursorLine.setAttribute('x1', xScale(p.x));
      cursorLine.setAttribute('x2', xScale(p.x));
      showTip(p, xScale, yScale);
    }
    function leave(){
      tip.hidden = true;
    }
    svg.onpointermove = (ev)=>{ updateFromClientX(ev.clientX); };
    svg.onpointerleave = leave;
    svg.ontouchstart = (ev)=>{ if(ev.touches?.[0]) updateFromClientX(ev.touches[0].clientX); };
    svg.ontouchmove = (ev)=>{ if(ev.touches?.[0]) updateFromClientX(ev.touches[0].clientX); };
  }

  function showTip(p, xScale, yScale){
    const items = state.cycles
      .map(cy => ({ key:cy.key, name:cy.name, color:`var(--${cy.key})`, val:p[cy.key] }))
      .sort((a,b)=> Math.abs(b.val) - Math.abs(a.val));

    tip.innerHTML = `
      <div class="t-date">${fmtDate(p.t)} — giorno ${daysBetween(state.birth,p.t)} dalla nascita</div>
      <ul>
        ${items.map(it=>`
          <li class="rowv">
            <span class="dot ${it.key}" style="width:10px;height:10px;border-radius:50%"></span>
            <span>${it.name}</span>
            <span class="val" style="margin-left:auto">${fmtPct(it.val)}</span>
          </li>`).join('')}
      </ul>
    `;
    tip.hidden = false;

    // margine extra e clamp robusto ai bordi
    const rect = svg.getBoundingClientRect();
    const x = xScale(p.x) - rect.left;
    const y = yScale(0) - rect.top - 10;
    tip.style.left = x + 'px';
    tip.style.top = y + 'px';

    const tw = tip.offsetWidth, th = tip.offsetHeight;
    const pad = 12;
    const left = clamp(x - tw/2, pad, rect.width - tw - pad);
    const top  = clamp(y - th - 10, pad, rect.height - th - pad);
    tip.style.left = left + 'px';
    tip.style.top = top + 'px';
  }

  function draw(){
    if(!state.birth || !state.center) return;
    state.width = 1000; state.height = 650; // viewBox fisso
    clearSVG();

    // Defs (gradient)
    const defs = el('defs', {});
    const grad = el('linearGradient',{id:'bgGrad', x1:'0',y1:'0',x2:'0',y2:'1'});
    grad.appendChild(el('stop',{offset:'0%', 'stop-color':'#101623'}));
    grad.appendChild(el('stop',{offset:'100%', 'stop-color':'#0c111b'}));
    defs.appendChild(grad);
    svg.appendChild(defs);

    const data = genData();
    const {l,r,t,b} = state.padding;
    const W = state.width, H = state.height;

    const xMin = 0, xMax = state.totalDays;
    const yMin = -1, yMax = 1;

    const xScale = x => l + ( (x - xMin) / (xMax - xMin) ) * (W - l - r);
    const yScale = y => H - b - ( (y - yMin) / (yMax - yMin) ) * (H - t - b);

    drawGrid(xScale,yScale,data);
    drawCurves(xScale,yScale,data);
    drawXAxisTicks();
    drawCursor(xScale,yScale,data);
  }

  function drawXAxisTicks(){
    const {l,r,t,b} = state.padding;
    const H = state.height, W = state.width;
    const start = new Date(state.center.getTime() - Math.floor(state.totalDays/2)*MS_DAY);
    const end = new Date(state.center.getTime() + Math.floor(state.totalDays/2)*MS_DAY);
    svg.appendChild(text(l, H-b+32, fmtDate(start), { 'text-anchor':'start', fill:'#9aa3b2', 'font-size':12 }));
    svg.appendChild(text(W-r, H-b+32, fmtDate(end), { 'text-anchor':'end', fill:'#9aa3b2', 'font-size':12 }));
  }

  // ---------- Export helpers ----------
  function resolveColor(varName){
    const root = getComputedStyle(document.documentElement);
    return root.getPropertyValue(varName).trim() || '#000';
  }

  async function exportCurrentChartPNG(scale=2){
    // Clona l’SVG e sostituisci i colori CSS var(--x) con valori assoluti
    const clone = svg.cloneNode(true);

    // sostituisci stroke calc con colori reali
    const colorMap = {
      p: resolveColor('--p'),
      e: resolveColor('--e'),
      i: resolveColor('--i'),
      zero: resolveColor('--zero'),
      grid: resolveColor('--grid')
    };
    clone.querySelectorAll('path').forEach(p=>{
      const s = p.getAttribute('stroke');
      if(s && s.startsWith('var(--')){
        const key = s.replace('var(--','').replace(')','').trim();
        p.setAttribute('stroke', colorMap[key] || '#000');
      }
    });
    clone.querySelectorAll('line').forEach(l=>{
      const s = l.getAttribute('stroke');
      if(s && s.startsWith('var(--')){
        const key = s.replace('var(--','').replace(')','').trim();
        l.setAttribute('stroke', colorMap[key] || '#000');
      }
    });
    // Forza font family in SVG per export
    clone.setAttribute('font-family', getComputedStyle(document.body).fontFamily);

    // Assicura namespace
    if(!clone.getAttribute('xmlns')) clone.setAttribute('xmlns','http://www.w3.org/2000/svg');

    const serializer = new XMLSerializer();
    const svgStr = serializer.serializeToString(clone);
    const svgBlob = new Blob([svgStr], {type:'image/svg+xml;charset=utf-8'});
    const url = URL.createObjectURL(svgBlob);

    const img = new Image();
    const vb = (svg.getAttribute('viewBox')||'0 0 1000 650').split(' ').map(Number);
    const w = vb[2], h = vb[3];

    const cnv = document.createElement('canvas');
    cnv.width = Math.round(w*scale);
    cnv.height = Math.round(h*scale);
    const ctx = cnv.getContext('2d');

    // Sfondo come nel canvas (gradiente approssimato)
    const g = ctx.createLinearGradient(0,0,0,cnv.height);
    g.addColorStop(0, '#101623'); g.addColorStop(1, '#0c111b');
    ctx.fillStyle = g; ctx.fillRect(0,0,cnv.width,cnv.height);

    await new Promise((res,rej)=>{
      img.onload = ()=>{ 
        ctx.drawImage(img, 0, 0, cnv.width, cnv.height);
        URL.revokeObjectURL(url);
        res();
      };
      img.onerror = rej;
      img.src = url;
    });
    return cnv.toDataURL('image/png');
  }

  function openPrintWindow(pngDataURL){
    const win = window.open('', '_blank');
    const title = 'Bioritmo';
    // A4 orizzontale: impaginazione responsive
    win.document.write(`
      <html><head><title>${title}</title>
      <style>
        @page { size: A4 landscape; margin: 12mm; }
        body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
        .wrap { display:flex; align-items:center; justify-content:center; padding:0; }
        img { max-width:100%; height:auto; display:block; }
        .meta { font-size:12px; color:#333; margin:10px 0; text-align:center; }
      </style>
      </head>
      <body>
        <div class="wrap">
          <div>
            <img src="${pngDataURL}" alt="Bioritmo" />
            <div class="meta">${metaString()}</div>
          </div>
        </div>
        <script>window.onload = () => setTimeout(()=> window.print(), 150);<\/script>
      </body></html>
    `);
    win.document.close();
  }

  function downloadDataURL(dataUrl, filename){
    const a = document.createElement('a');
    a.href = dataUrl; a.download = filename;
    document.body.appendChild(a); a.click(); a.remove();
  }

  function fileBaseName(){
    const b = birthEl.value || 'nascita';
    const c = centerEl.value || 'centro';
    return `bioritmo_${b}_ref_${c}`;
  }

  function metaString(){
    return `Nascita: ${birthEl.value} · Riferimento: ${centerEl.value} · Intervallo: ${rangeEl.value}g · Granularità: ${granEl.value}g`;
  }

  // ---------- SVG helpers ----------
  function el(n, attrs){ const e = document.createElementNS('http://www.w3.org/2000/svg', n); for(const k in attrs){ e.setAttribute(k, attrs[k]); } return e; }
  const line = (x1,y1,x2,y2,attrs={})=>{ const e=el('line',{x1,y1,x2,y2,...attrs}); return e; };
  const rect = (x,y,w,h,attrs={})=>{ const e=el('rect',{x,y,width:w,height:h,...attrs}); return e; };
  const text = (x,y,txt,attrs={})=>{ const e=el('text',{x,y,...attrs}); e.textContent = txt; return e; };

  // Polilinea lineare
  function pathLinear(points){
    if(points.length<2) return '';
    let d = `M ${points[0][0]} ${points[0][1]}`;
    for(let i=1;i<points.length;i++){
      d += ` L ${points[i][0]} ${points[i][1]}`;
    }
    return d;
  }

  function fmtDate(d){
    const months = ['gen','feb','mar','apr','mag','giu','lug','ago','set','ott','nov','dic'];
    return `${String(d.getDate()).padStart(2,'0')} ${months[d.getMonth()]} ${d.getFullYear()}`;
  }

  function toast(msg){
    const t = document.createElement('div');
    t.textContent = msg;
    Object.assign(t.style, {
      position:'fixed', left:'50%', bottom:'20px', transform:'translateX(-50%)',
      background:'#111827', color:'#e5e7eb', border:'1px solid #374151',
      padding:'10px 14px', borderRadius:'10px', zIndex:9999, boxShadow:'0 8px 24px rgba(0,0,0,.35)',
      fontSize:'13px'
    });
    document.body.appendChild(t);
    setTimeout(()=>{ t.style.opacity='0'; t.style.transition='opacity .3s'; }, 1600);
    setTimeout(()=> t.remove(), 2000);
  }

  // Primo disegno
  draw(); pushURL();
})();
</script>
</body>
</html>